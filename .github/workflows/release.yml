name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install dependencies
        run: npm ci

      - name: Setup signing key
        run: |
          # Verify signing key is set
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]; then
            echo "ERROR: TAURI_SIGNING_PRIVATE_KEY secret is not set!"
            exit 1
          fi
          echo "✓ TAURI_SIGNING_PRIVATE_KEY secret exists in GitHub"
          if [ -n "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" ]; then
            echo "✓ TAURI_SIGNING_PRIVATE_KEY_PASSWORD secret exists in GitHub"
          else
            echo "WARNING: TAURI_SIGNING_PRIVATE_KEY_PASSWORD is not set (key may be unencrypted)"
          fi

      - name: Build Tauri app
        run: npm run tauri:build 2>&1 | tee build.log
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        
      - name: Check build output for errors
        run: |
          echo "=== Checking build log for signing/updater errors ==="
          grep -i "sign\|updater\|latest.json\|error\|fail\|warning" build.log | tail -100 || echo "No signing/updater messages found"
          echo ""
          echo "=== Full build log (last 200 lines) ==="
          tail -200 build.log
          echo ""
          echo "=== Checking if latest.json exists anywhere ==="
          find src-tauri/target -name "latest.json" 2>/dev/null || echo "latest.json not found anywhere in target directory"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: FileFlow.dmg
          path: src-tauri/target/release/bundle/dmg/FileFlow.dmg

      - name: List bundle directory
        run: |
          echo "=== Full bundle directory structure ==="
          find src-tauri/target/release/bundle -type f | head -50
          echo ""
          echo "=== Looking for update artifacts (all locations) ==="
          find src-tauri/target/release -type f \( -name "*.tar.gz" -o -name "*.sig" -o -name "latest.json" \) 2>/dev/null || true
          echo ""
          echo "=== Checking specific directories ==="
          ls -la src-tauri/target/release/bundle/ || echo "bundle directory not found"
          ls -la src-tauri/target/release/bundle/macos/ 2>/dev/null || echo "macos directory not found"
          ls -la src-tauri/target/release/bundle/dmg/ 2>/dev/null || echo "dmg directory not found"

      - name: Upload update artifacts
        uses: actions/upload-artifact@v4
        with:
          name: update-artifacts
          path: |
            src-tauri/target/release/bundle/**/*.tar.gz
            src-tauri/target/release/bundle/**/*.sig
            src-tauri/target/release/bundle/**/latest.json
          if-no-files-found: ignore

      - name: Find and prepare update artifacts
        id: find-artifacts
        run: |
          echo "=== Finding update artifacts (searching all locations) ==="
          LATEST_JSON=$(find src-tauri/target/release -name "latest.json" 2>/dev/null | head -1)
          TAR_GZ=$(find src-tauri/target/release -name "*.tar.gz" 2>/dev/null | head -1)
          SIG=$(find src-tauri/target/release -name "*.sig" 2>/dev/null | head -1)
          
          echo "Search results:"
          echo "  latest.json: ${LATEST_JSON:-NOT FOUND}"
          echo "  tar.gz: ${TAR_GZ:-NOT FOUND}"
          echo "  sig: ${SIG:-NOT FOUND}"
          
          # If latest.json is missing but tar.gz and sig exist, try to generate it manually
          if [ -z "$LATEST_JSON" ] && [ -n "$TAR_GZ" ] && [ -n "$SIG" ]; then
            echo "WARNING: latest.json missing but tar.gz and sig exist"
            echo "Attempting to generate latest.json manually..."
            VERSION=$(grep -m1 "^version" src-tauri/Cargo.toml | cut -d'"' -f2)
            APP_NAME=$(grep -m1 "^name" src-tauri/Cargo.toml | cut -d'"' -f2)
            PRODUCT_NAME=$(grep -m1 '"productName"' src-tauri/tauri.conf.json | cut -d'"' -f4)
            TAR_GZ_DIR=$(dirname "$TAR_GZ")
            TAR_GZ_FILE=$(basename "$TAR_GZ")
            SIG_FILE=$(basename "$SIG")
            
            # Get the download URL (will be set by GitHub release)
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$TAR_GZ_FILE"
            
            # Read signature
            SIGNATURE=$(cat "$SIG" | base64 -w 0 2>/dev/null || cat "$SIG" | base64)
            
            # Create latest.json
            LATEST_JSON="$TAR_GZ_DIR/latest.json"
            cat > "$LATEST_JSON" <<EOF
{
  "version": "$VERSION",
  "notes": "Release $VERSION",
  "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "platforms": {
    "darwin-aarch64": {
      "signature": "$SIGNATURE",
      "url": "$DOWNLOAD_URL"
    }
  }
}
EOF
            echo "Generated latest.json at: $LATEST_JSON"
            echo "=== Generated latest.json contents ==="
            cat "$LATEST_JSON"
          fi
          
          if [ -n "$LATEST_JSON" ]; then
            echo "Found latest.json: $LATEST_JSON"
            echo "latest_json=$LATEST_JSON" >> $GITHUB_OUTPUT
            echo "=== latest.json contents ==="
            cat "$LATEST_JSON"
          else
            echo "ERROR: latest.json not found!"
            echo "This usually means the signing key failed or createUpdaterArtifacts is not working."
            echo "Check the build log above for signing errors."
            exit 1
          fi
          
          if [ -n "$TAR_GZ" ]; then
            echo "Found tar.gz: $TAR_GZ"
            echo "tar_gz=$TAR_GZ" >> $GITHUB_OUTPUT
          else
            echo "WARNING: tar.gz not found"
          fi
          
          if [ -n "$SIG" ]; then
            echo "Found sig: $SIG"
            echo "sig=$SIG" >> $GITHUB_OUTPUT
          else
            echo "WARNING: sig file not found"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/release/bundle/dmg/FileFlow.dmg
            ${{ steps.find-artifacts.outputs.tar_gz }}
            ${{ steps.find-artifacts.outputs.sig }}
            ${{ steps.find-artifacts.outputs.latest_json }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

